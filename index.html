<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia - Afinador de Lira</title>
    <!-- Metadatos para compartir en redes sociales -->
    <meta property="og:title" content="Harmonia - Afinador de Lira Griega">
    <meta property="og:description" content="Afinador interactivo, generador de música y oráculo de sonido para instrumentos antiguos.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-parchment: #fdf6e3;
            --text-primary: #4b3621;
            --accent-terracotta: #b85c38;
            --accent-gold: #c5a059;
            --wood-dark: #3e2723;
            --tune-flat: #3b82f6; 
            --tune-sharp: #ef4444; 
            --tune-good: #10b981;  
        }

        body {
            background-color: var(--bg-parchment);
            color: var(--text-primary);
            font-family: 'IM Fell English', serif;
            background-image: 
                radial-gradient(#e6dcb8 1px, transparent 1px),
                linear-gradient(to right, rgba(197, 160, 89, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(197, 160, 89, 0.1) 1px, transparent 1px);
            background-size: 20px 20px, 40px 40px, 40px 40px;
            user-select: none;
            -webkit-user-select: none;
        }

        h1, h2, h3, button, select, label, .cinzel-font {
            font-family: 'Cinzel', serif;
        }

        .temple-border {
            border: 8px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='30' height='30' viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h30v30H0z' fill='none'/%3E%3Cpath d='M2 2v26h26V2H2zm2 2h22v22H4V4z' fill='%23c5a059'/%3E%3Cpath d='M8 8v14h14V8H8zm2 2h10v10H10V10z' fill='%23b85c38'/%3E%3C/svg%3E") 30 stretch;
            box-shadow: 0 10px 30px rgba(75, 54, 33, 0.2);
        }

        .greek-input {
            background-color: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--accent-gold);
            color: var(--text-primary);
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
        }

        .btn-muse {
            background: linear-gradient(135deg, var(--accent-terracotta), #8a4226);
            color: #fff;
            border: 2px solid var(--wood-dark);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.3s;
        }
        .btn-muse:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(184, 92, 56, 0.4); }
        .btn-muse:active { transform: translateY(1px); }
        .btn-muse.playing { background: var(--wood-dark); border-color: var(--accent-gold); }

        .btn-tuner {
            background: linear-gradient(135deg, #1f2937, #111827);
            color: #fbbf24;
            border: 2px solid var(--accent-gold);
        }
        .btn-tuner.active {
            background: var(--accent-gold);
            color: #1f2937;
            box-shadow: 0 0 15px var(--accent-gold);
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--accent-gold);
            color: var(--text-primary);
            border-radius: 4px;
            padding: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-icon:hover { background: var(--accent-terracotta); color: white; }
        .btn-icon.active { background: var(--accent-terracotta); color: white; }

        /* Animaciones */
        @keyframes stringPluck {
            0% { stroke: #ffffff; stroke-width: 4px; filter: drop-shadow(0 0 5px white); transform: translateX(0); }
            10% { stroke: var(--accent-terracotta); transform: translateX(2px); }
            20% { transform: translateX(-2px); }
            30% { transform: translateX(1px); }
            40% { transform: translateX(-1px); }
            100% { stroke: #d4b483; stroke-width: 1.5px; transform: translateX(0); }
        }
        .string-active { animation: stringPluck 0.8s ease-out; }

        .string-line { transition: stroke 0.1s; pointer-events: none; }
        .string-hitbox { stroke: transparent; cursor: pointer; stroke-width: 25px; }
        .string-hitbox:hover + .string-line { stroke: var(--accent-terracotta); stroke-width: 3; }

        .string-tuning-flat { stroke: var(--tune-flat) !important; stroke-width: 4px !important; }
        .string-tuning-sharp { stroke: var(--tune-sharp) !important; stroke-width: 4px !important; }
        .string-tuning-good { stroke: var(--tune-good) !important; stroke-width: 4px !important; filter: drop-shadow(0 0 5px var(--tune-good)); }

        input[type=range] { accent-color: var(--accent-terracotta); }
        
        .settings-panel {
            background: rgba(253, 246, 227, 0.95);
            border: 2px solid var(--accent-gold);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top right;
        }
        .settings-panel.hidden-panel { opacity: 0; transform: scale(0.95); pointer-events: none; display: none; }
        
        .tuner-panel {
            background: rgba(31, 41, 55, 0.95);
            border-top: 4px solid var(--accent-gold);
            color: #f3f4f6;
            transition: transform 0.3s ease-in-out;
        }
        .tuner-panel.hidden-tuner { transform: translateY(100%); }

        .tuner-needle {
            transition: transform 0.1s ease-out;
            transform-origin: bottom center;
        }

        #lyre-svg { touch-action: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-parchment); }
        ::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Menú Superior -->
    <div class="fixed top-4 right-4 z-50 flex items-center gap-2 bg-white/90 p-2 rounded-lg shadow-lg border border-[#c5a059]">
        <div class="flex items-center gap-2 px-2 border-r border-[#c5a059]">
            <svg class="w-4 h-4 text-[#4b3621]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
            <input type="range" min="0" max="1" step="0.1" value="0.5" class="w-16 md:w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="setVolume(this.value)" title="Volumen Maestro">
        </div>
        <button id="btn-settings" onclick="toggleSettings()" class="btn-icon" title="Ajustes de Sonido">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
        <button onclick="toggleFullScreen()" class="btn-icon" title="Pantalla Completa">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
        </button>
        <button onclick="window.location.reload()" class="btn-icon" title="Reiniciar Página">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        </button>
    </div>

    <!-- Panel de Ajustes -->
    <div id="settings-panel" class="settings-panel hidden-panel fixed top-20 right-4 z-40 w-72 p-6 rounded-lg shadow-2xl">
        <h3 class="text-center font-bold text-[#b85c38] uppercase border-b border-[#c5a059] pb-2 mb-4">Ajustes del Luthier</h3>
        <div class="mb-4">
            <label class="block text-xs font-bold uppercase mb-1 text-[#4b3621]">Presets</label>
            <select id="preset-select" class="greek-input w-full p-1 text-sm rounded" onchange="applyPreset(this.value)">
                <option value="custom">Personalizado</option>
                <option value="default" selected>Lira Suave (Por Defecto)</option>
                <option value="harp">Arpa Etérea</option>
                <option value="warrior">Lira Guerrera</option>
                <option value="dream">Onírico</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-xs font-bold uppercase mb-1 text-[#4b3621]">Onda</label>
            <select id="wave-type" class="greek-input w-full p-1 text-sm rounded" onchange="updateAudioParams('waveType', this.value)">
                <option value="triangle" selected>Triangular</option>
                <option value="sawtooth">Diente de Sierra</option>
                <option value="square">Cuadrada</option>
            </select>
        </div>
        <div class="space-y-4">
            <div><div class="flex justify-between text-xs text-[#4b3621]"><label>Reverb</label><span id="val-reverb">30%</span></div><input id="slider-reverb" type="range" min="0" max="1" step="0.1" value="0.3" class="w-full h-1 bg-gray-300 rounded" oninput="updateAudioParams('reverb', this.value)"></div>
            <div><div class="flex justify-between text-xs text-[#4b3621]"><label>Ataque</label><span id="val-attack">0.02s</span></div><input id="slider-attack" type="range" min="0.005" max="0.2" step="0.005" value="0.02" class="w-full h-1 bg-gray-300 rounded" oninput="updateAudioParams('attack', this.value)"></div>
            <div><div class="flex justify-between text-xs text-[#4b3621]"><label>Decay</label><span id="val-decay">2.0s</span></div><input id="slider-decay" type="range" min="0.5" max="5.0" step="0.1" value="2.0" class="w-full h-1 bg-gray-300 rounded" oninput="updateAudioParams('decay', this.value)"></div>
            <div><div class="flex justify-between text-xs text-[#4b3621]"><label>Brillo</label><span id="val-brightness">4x</span></div><input id="slider-brightness" type="range" min="1" max="10" step="0.5" value="4" class="w-full h-1 bg-gray-300 rounded" oninput="updateAudioParams('brightness', this.value)"></div>
        </div>
    </div>

    <!-- UI Principal -->
    <main id="app-container" class="temple-border bg-white/90 backdrop-blur-sm max-w-5xl w-full grid grid-cols-1 lg:grid-cols-2 gap-8 p-6 lg:p-10 relative overflow-hidden transition-all duration-500 pb-24">
        <div class="absolute top-0 left-4 w-4 h-full border-x-2 border-dotted border-yellow-700/20 opacity-50 pointer-events-none"></div>
        <div class="absolute top-0 right-4 w-4 h-full border-x-2 border-dotted border-yellow-700/20 opacity-50 pointer-events-none"></div>

        <!-- Controles -->
        <div class="flex flex-col gap-5 z-10">
            <header class="text-center border-b-2 border-[#c5a059] pb-4">
                <h1 class="text-4xl lg:text-5xl font-bold text-[#b85c38] tracking-widest uppercase mb-2">Harmonia</h1>
                <p class="text-lg italic text-[#4b3621]">Afinador de Cítaras y Liras Antiguas</p>
            </header>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 text-[#4b3621] uppercase tracking-wider">Cuerdas</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="strings-range" min="3" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg" oninput="updateStringsDisplay(this.value)">
                        <span id="strings-val" class="text-2xl font-bold text-[#b85c38] w-12 text-center cinzel-font">7</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-1 text-[#4b3621] uppercase tracking-wider">Modo Griego</label>
                    <select id="mode" onchange="updateTuning()" class="greek-input w-full p-2 rounded text-lg cursor-pointer">
                        <option value="ionian">Jónico (Alegre / Heroico)</option>
                        <option value="dorian" selected>Dórico (Serio / Guerrero)</option>
                        <option value="phrygian">Frigio (Místico / Extático)</option>
                        <option value="lydian">Lidio (Etéreo / Solemne)</option>
                        <option value="mixolydian">Mixolidio (Festivo / Trágico)</option>
                        <option value="aeolian">Eólico (Melancólico)</option>
                        <option value="locrian">Locrio (Inestable / Extraño)</option>
                    </select>
                </div>

                <div class="bg-[#e6dcb8]/50 p-3 rounded border border-[#c5a059]">
                    <label class="block text-sm font-bold mb-1 text-[#4b3621] uppercase text-center">Transposición</label>
                    <div class="flex items-center justify-between gap-2">
                        <button onclick="changeTranspose(-1)" class="greek-input w-10 h-10 hover:bg-[#b85c38] hover:text-white font-bold text-xl rounded">-</button>
                        <div class="text-center">
                            <span id="root-note" class="block text-2xl font-bold cinzel-font text-[#3e2723]">C (Do)</span>
                            <span id="transpose-val" class="text-xs uppercase opacity-75">Semitonos: 0</span>
                        </div>
                        <button onclick="changeTranspose(1)" class="greek-input w-10 h-10 hover:bg-[#b85c38] hover:text-white font-bold text-xl rounded">+</button>
                    </div>
                </div>

                <div class="pt-2 border-t border-dotted border-[#c5a059] flex flex-col gap-3">
                    <button id="btn-tuner" onclick="toggleTuner()" class="btn-tuner w-full py-2 px-4 rounded text-lg font-bold uppercase tracking-widest flex items-center justify-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        <span>Microfono (Afinar)</span>
                    </button>

                    <button id="play-btn" onclick="toggleMusic()" class="btn-muse w-full py-3 px-6 rounded text-lg font-bold uppercase tracking-widest flex items-center justify-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                        <span>Invocar a las Musas</span>
                    </button>
                    
                    <div class="flex flex-col gap-1 px-2">
                        <div class="flex justify-between text-xs font-bold uppercase text-[#4b3621] opacity-70"><span>Lento</span><span>Tempo</span><span>Rápido</span></div>
                        <input type="range" min="1" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg" oninput="updateTempo(this.value)">
                    </div>

                    <div>
                        <select id="song-select" class="greek-input w-full p-2 text-sm rounded cursor-pointer" onchange="playSong(this.value)">
                            <option value="">-- Interpretar Obra Antigua --</option>
                            <option value="seikilos">Epitafio de Seikilos</option>
                            <option value="orestes">Estásimo de Orestes</option>
                            <option value="apollo">Peán a Apolo</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualización -->
        <div class="flex flex-col items-center justify-between z-10 lg:border-l-2 lg:border-dotted lg:border-[#c5a059] lg:pl-10 pt-8 lg:pt-0">
            <div class="relative w-full max-w-[300px] h-[400px] drop-shadow-2xl filter mb-6 select-none" id="lyre-container">
                <svg id="lyre-svg" viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                    <!-- SVG dinámico -->
                </svg>
            </div>

            <div class="w-full bg-[#fffefae0] border border-[#c5a059] rounded p-4">
                <h3 class="text-center text-sm uppercase font-bold text-[#b85c38] mb-3 border-b border-[#e6dcb8] pb-2">Notas Requeridas</h3>
                <div id="tuning-display" class="flex flex-wrap justify-center gap-2 max-h-[150px] overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <!-- Afinador -->
    <div id="tuner-overlay" class="tuner-panel hidden-tuner fixed bottom-0 left-0 w-full h-48 z-50 flex flex-col items-center justify-center shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        <div class="absolute top-4 right-4 cursor-pointer" onclick="toggleTuner()">
            <svg class="w-6 h-6 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </div>
        <h3 class="text-accent-gold uppercase tracking-widest text-sm mb-2">Oráculo del Sonido</h3>
        <div class="flex items-baseline gap-4 mb-2">
            <span id="tuner-note" class="text-6xl font-bold text-white cinzel-font">--</span>
            <span id="tuner-hz" class="text-xl text-gray-400 font-mono">0 Hz</span>
        </div>
        <div class="relative w-64 h-8 bg-gray-700 rounded-full overflow-hidden border border-gray-500">
            <div class="absolute left-0 w-1/2 h-full bg-gradient-to-r from-blue-900 to-blue-500 opacity-30"></div>
            <div class="absolute right-0 w-1/2 h-full bg-gradient-to-r from-red-500 to-red-900 opacity-30"></div>
            <div class="absolute left-1/2 w-1 h-full bg-green-500 -translate-x-1/2 z-10"></div>
            <div id="tuner-needle" class="absolute left-1/2 top-0 h-full w-2 bg-white border border-black -translate-x-1/2 transition-transform duration-100 ease-out z-20 shadow-lg"></div>
        </div>
        <p id="tuner-feedback" class="text-sm mt-2 font-bold text-[#fbbf24]">Escuchando...</p>
    </div>

    <script>
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const MODES = { ionian: [0, 2, 4, 5, 7, 9, 11], dorian: [0, 2, 3, 5, 7, 9, 10], phrygian: [0, 1, 3, 5, 7, 8, 10], lydian: [0, 2, 4, 6, 7, 9, 11], mixolydian: [0, 2, 4, 5, 7, 9, 10], aeolian: [0, 2, 3, 5, 7, 8, 10], locrian: [0, 1, 3, 5, 6, 8, 10] };
        const PRESETS = { 'default': { waveType: 'triangle', attack: 0.02, decay: 2.0, brightness: 4, reverb: 0.3 }, 'harp': { waveType: 'triangle', attack: 0.05, decay: 4.0, brightness: 2, reverb: 0.6 }, 'warrior': { waveType: 'sawtooth', attack: 0.01, decay: 1.5, brightness: 8, reverb: 0.2 }, 'dream': { waveType: 'triangle', attack: 0.1, decay: 5.0, brightness: 3, reverb: 0.8 } };
        const SONGS = { 'seikilos': { mode: 'mixolydian', strings: 7, notes: [{s:2, d:600}, {s:6, d:800}, {s:6, d:400}, {s:4, d:400}, {s:5, d:400}, {s:6, d:800}, {s:5, d:400}, {s:4, d:400}, {s:3, d:400}, {s:2, d:1200}, {s:1, d:400}, {s:2, d:400}, {s:3, d:800}, {s:4, d:400}, {s:3, d:400}, {s:2, d:400}, {s:1, d:800}, {s:0, d:400}, {s:1, d:400}, {s:2, d:1200}] }, 'orestes': { mode: 'phrygian', strings: 7, notes: [{s:6, d:300}, {s:5, d:300}, {s:4, d:600}, {s:2, d:300}, {s:5, d:300}, {s:4, d:200}, {s:3, d:200}, {s:4, d:200}, {s:3, d:600}, {s:1, d:800}, {s:3, d:400}, {s:0, d:1200}] }, 'apollo': { mode: 'dorian', strings: 7, notes: [{s:2, d:600}, {s:2, d:400}, {s:4, d:600}, {s:3, d:400}, {s:5, d:600}, {s:4, d:400}, {s:6, d:600}, {s:5, d:400}, {s:4, d:400}, {s:3, d:400}, {s:2, d:400}, {s:1, d:400}, {s:0, d:1200}] } };

        let state = { strings: 7, mode: 'dorian', transpose: 0, isPlaying: false, isSongPlaying: false, isTunerActive: false, freqs: [], tempoFactor: 0.5, volume: 0.5, audioParams: { ...PRESETS['default'] } };
        let audioCtx = null, masterGain = null, reverbNode = null, sequencerId = null, isMouseDown = false, analyser = null, microphoneStream = null, tunerRafId = null;
        let tunerDataArray = new Float32Array(2048);

        window.addEventListener('load', () => {
            updateTuning();
            document.addEventListener('mousedown', () => isMouseDown = true);
            document.addEventListener('mouseup', () => isMouseDown = false);
            const lyreContainer = document.getElementById('lyre-container');
            lyreContainer.addEventListener('touchmove', handleTouchStrum, { passive: false });
        });

        // --- FUNCIONES DE DIBUJO (Esenciales para que se vea la Lira) ---
        function drawLyre(num) {
            const svg = document.getElementById('lyre-svg');
            svg.innerHTML = '';

            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            defs.innerHTML = `
                <linearGradient id="woodGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#5c4033;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#8b5a2b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#5c4033;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="goldGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#b8860b;stop-opacity:1" />
                </linearGradient>
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="3" dy="3" stdDeviation="3" flood-opacity="0.5"/>
                </filter>
            `;
            svg.appendChild(defs);

            // Cuerpo
            const body = document.createElementNS("http://www.w3.org/2000/svg", "path");
            body.setAttribute("d", "M 60 120 Q 40 360 150 390 Q 260 360 240 120 L 220 120 Q 230 320 150 340 Q 70 320 80 120 Z");
            body.setAttribute("fill", "url(#woodGrad)");
            body.setAttribute("stroke", "#3e2723");
            body.setAttribute("stroke-width", "3");
            body.setAttribute("filter", "url(#shadow)");
            svg.appendChild(body);

            // Brazos y puente
            const leftArm = document.createElementNS("http://www.w3.org/2000/svg", "path");
            leftArm.setAttribute("d", "M 60 120 Q 50 60 30 50 L 50 50 Q 70 60 80 120 Z");
            leftArm.setAttribute("fill", "url(#woodGrad)");
            svg.appendChild(leftArm);
            const rightArm = document.createElementNS("http://www.w3.org/2000/svg", "path");
            rightArm.setAttribute("d", "M 240 120 Q 250 60 270 50 L 250 50 Q 230 60 220 120 Z");
            rightArm.setAttribute("fill", "url(#woodGrad)");
            svg.appendChild(rightArm);
            const yoke = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            yoke.setAttribute("x", "25"); yoke.setAttribute("y", "45"); yoke.setAttribute("width", "250"); yoke.setAttribute("height", "20"); yoke.setAttribute("rx", "5");
            yoke.setAttribute("fill", "url(#woodGrad)"); yoke.setAttribute("stroke", "#3e2723");
            svg.appendChild(yoke);
            const decor = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            decor.setAttribute("cx", "150"); decor.setAttribute("cy", "55"); decor.setAttribute("r", "6"); decor.setAttribute("fill", "url(#goldGrad)");
            svg.appendChild(decor);
            const bridge = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            bridge.setAttribute("x", "100"); bridge.setAttribute("y", "350"); bridge.setAttribute("width", "100"); bridge.setAttribute("height", "10"); bridge.setAttribute("fill", "#2d1b10");
            svg.appendChild(bridge);

            // Cuerdas
            const topY = 65, bottomY = 350, topWidth = 160, bottomWidth = 80, topStartX = 150 - (topWidth/2), bottomStartX = 150 - (bottomWidth/2);

            for (let i = 0; i < num; i++) {
                const t = num > 1 ? i / (num - 1) : 0.5;
                const x1 = topStartX + (topWidth * t);
                const x2 = bottomStartX + (bottomWidth * t);
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");

                const lineVisual = document.createElementNS("http://www.w3.org/2000/svg", "line");
                lineVisual.setAttribute("x1", x1); lineVisual.setAttribute("y1", topY); lineVisual.setAttribute("x2", x2); lineVisual.setAttribute("y2", bottomY);
                lineVisual.setAttribute("class", "string-line"); lineVisual.setAttribute("stroke", "#d4b483"); lineVisual.setAttribute("stroke-width", "1.5"); lineVisual.setAttribute("id", `str-${i}`);
                
                const lineHit = document.createElementNS("http://www.w3.org/2000/svg", "line");
                lineHit.setAttribute("x1", x1); lineHit.setAttribute("y1", topY); lineHit.setAttribute("x2", x2); lineHit.setAttribute("y2", bottomY);
                lineHit.setAttribute("class", "string-hitbox"); lineHit.setAttribute("id", `hit-${i}`);
                lineHit.addEventListener('mousedown', () => playTone(state.freqs[i], i));
                lineHit.addEventListener('mouseenter', () => { if (isMouseDown) playTone(state.freqs[i], i); });

                g.appendChild(lineVisual); g.appendChild(lineHit); svg.appendChild(g);
                const peg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                peg.setAttribute("cx", x1); peg.setAttribute("cy", topY - 5); peg.setAttribute("r", "2.5"); peg.setAttribute("fill", "#000"); svg.appendChild(peg);
            }
        }

        // --- LÓGICA PRINCIPAL ---
        function updateTuning() {
            state.mode = document.getElementById('mode').value;
            const rootNoteName = getNoteName(state.transpose);
            document.getElementById('root-note').innerText = `${rootNoteName}`;
            document.getElementById('transpose-val').innerText = `Semitonos: ${state.transpose > 0 ? '+' : ''}${state.transpose}`;
            const data = calculateScale();
            state.freqs = data.freqs;
            const container = document.getElementById('tuning-display');
            container.innerHTML = '';
            data.notes.forEach((n, idx) => {
                const tag = document.createElement('div');
                tag.className = "flex flex-col items-center bg-[#4b3621] text-[#fdf6e3] px-3 py-1 rounded shadow-md border border-[#c5a059]";
                tag.innerHTML = `<span class="font-bold text-lg cinzel-font">${n.name}${n.octave}</span><span class="text-[0.6rem] opacity-80 font-mono">${Math.round(n.freq)}Hz</span><span class="text-[0.6rem] text-[#c5a059]">Cda ${idx+1}</span>`;
                tag.onclick = () => playTone(n.freq, idx);
                tag.style.cursor = 'pointer';
                container.appendChild(tag);
            });
            drawLyre(state.strings);
        }

        // --- AUDIO Y AFINADOR ---
        async function toggleTuner() {
            const panel = document.getElementById('tuner-overlay');
            const btn = document.getElementById('btn-tuner');
            if (state.isTunerActive) {
                state.isTunerActive = false;
                panel.classList.add('hidden-tuner');
                btn.classList.remove('active');
                if (tunerRafId) cancelAnimationFrame(tunerRafId);
                resetStringVisuals();
            } else {
                if (state.isPlaying) toggleMusic();
                initAudio();
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphoneStream = audioCtx.createMediaStreamSource(stream);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 2048;
                    microphoneStream.connect(analyser);
                    state.isTunerActive = true;
                    panel.classList.remove('hidden-tuner');
                    btn.classList.add('active');
                    updatePitch();
                } catch (err) {
                    alert("No se pudo acceder al micrófono.");
                }
            }
        }

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length;
            let rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;
            let r1 = 0, r2 = SIZE - 1, thres = 0.2;
            for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
            buf = buf.slice(r1, r2);
            SIZE = buf.length;
            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];
            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
            let T0 = maxpos;
            return sampleRate / T0;
        }

        function updatePitch() {
            if (!state.isTunerActive) return;
            analyser.getFloatTimeDomainData(tunerDataArray);
            const ac = autoCorrelate(tunerDataArray, audioCtx.sampleRate);
            const noteEl = document.getElementById('tuner-note');
            const hzEl = document.getElementById('tuner-hz');
            const needleEl = document.getElementById('tuner-needle');
            const feedbackEl = document.getElementById('tuner-feedback');
            resetStringVisuals();

            if (ac === -1) { tunerRafId = requestAnimationFrame(updatePitch); return; }
            const pitch = ac;
            hzEl.innerText = Math.round(pitch) + " Hz";
            let closestStringIndex = -1, minDiff = Infinity;
            state.freqs.forEach((freq, idx) => { const diff = Math.abs(freq - pitch); if (diff < minDiff) { minDiff = diff; closestStringIndex = idx; } });

            if (closestStringIndex !== -1) {
                const targetFreq = state.freqs[closestStringIndex];
                const noteNum = 12 * (Math.log(pitch / 440) / Math.log(2)) + 69;
                noteEl.innerText = NOTES[Math.round(noteNum) % 12];
                const cents = 1200 * Math.log2(pitch / targetFreq);
                let angle = cents; if (angle > 45) angle = 45; if (angle < -45) angle = -45;
                needleEl.style.transform = `translateX(-50%) rotate(${angle}deg)`;
                const strEl = document.getElementById(`str-${closestStringIndex}`);
                if (Math.abs(cents) < 10) { feedbackEl.innerText = "¡AFINADA!"; feedbackEl.style.color = "#10b981"; needleEl.style.backgroundColor = "#10b981"; if(strEl) strEl.classList.add('string-tuning-good'); }
                else if (cents < 0) { feedbackEl.innerText = "Bajo: Tensa"; feedbackEl.style.color = "#3b82f6"; needleEl.style.backgroundColor = "#3b82f6"; if(strEl) strEl.classList.add('string-tuning-flat'); }
                else { feedbackEl.innerText = "Alto: Afloja"; feedbackEl.style.color = "#ef4444"; needleEl.style.backgroundColor = "#ef4444"; if(strEl) strEl.classList.add('string-tuning-sharp'); }
            }
            tunerRafId = requestAnimationFrame(updatePitch);
        }

        function resetStringVisuals() { document.querySelectorAll('.string-line').forEach(s => s.classList.remove('string-tuning-flat', 'string-tuning-sharp', 'string-tuning-good')); }

        // --- AUDIO ENGINE ---
        function createReverbBuffer(duration) {
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * duration;
            const impulse = audioCtx.createBuffer(2, length, sampleRate);
            for (let channel = 0; channel < 2; channel++) {
                const impulseData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) impulseData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
            }
            return impulse;
        }

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = state.volume;
                reverbNode = audioCtx.createConvolver();
                reverbNode.buffer = createReverbBuffer(3.0); 
                masterGain.connect(audioCtx.destination);
                reverbNode.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, strIndex) {
            initAudio();
            const now = audioCtx.currentTime;
            const { waveType, attack, decay, brightness, reverb } = state.audioParams;
            const osc = audioCtx.createOscillator(); osc.type = waveType; osc.frequency.setValueAtTime(freq, now);
            const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.Q.value = 0.5;
            filter.frequency.setValueAtTime(freq * brightness, now); filter.frequency.exponentialRampToValueAtTime(freq, now + (decay * 0.15));
            const noteGain = audioCtx.createGain(); noteGain.gain.setValueAtTime(0, now);
            noteGain.gain.linearRampToValueAtTime(0.4, now + attack); noteGain.gain.exponentialRampToValueAtTime(0.001, now + decay);
            const reverbSend = audioCtx.createGain(); reverbSend.gain.value = reverb;
            osc.connect(filter); filter.connect(noteGain); noteGain.connect(masterGain); noteGain.connect(reverbSend); reverbSend.connect(reverbNode);
            osc.start(now); osc.stop(now + decay + 0.5);
            const strEl = document.getElementById(`str-${strIndex}`);
            if (strEl) { strEl.classList.remove('string-active'); strEl.getBoundingClientRect(); strEl.classList.add('string-active'); }
        }

        // --- HELPERS ---
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            const btn = document.getElementById('btn-settings');
            if (panel.classList.contains('hidden-panel')) { panel.classList.remove('hidden-panel'); panel.style.display = 'block'; btn.classList.add('active'); }
            else { panel.classList.add('hidden-panel'); setTimeout(() => panel.style.display = 'none', 300); btn.classList.remove('active'); }
        }
        function applyPreset(name) {
            if (name === 'custom') return;
            const p = PRESETS[name]; state.audioParams = { ...p };
            document.getElementById('wave-type').value = p.waveType; document.getElementById('slider-attack').value = p.attack;
            document.getElementById('slider-decay').value = p.decay; document.getElementById('slider-brightness').value = p.brightness;
            document.getElementById('slider-reverb').value = p.reverb;
            document.getElementById('val-reverb').innerText = Math.round(p.reverb * 100) + '%'; document.getElementById('val-attack').innerText = p.attack + 's';
            document.getElementById('val-decay').innerText = p.decay + 's'; document.getElementById('val-brightness').innerText = p.brightness + 'x';
        }
        function updateAudioParams(param, value) {
            document.getElementById('preset-select').value = 'custom';
            if (param === 'waveType') state.audioParams.waveType = value; else state.audioParams[param] = parseFloat(value);
            if (param === 'attack') document.getElementById('val-attack').innerText = value + 's';
            if (param === 'decay') document.getElementById('val-decay').innerText = value + 's';
            if (param === 'brightness') document.getElementById('val-brightness').innerText = value + 'x';
            if (param === 'reverb') document.getElementById('val-reverb').innerText = Math.round(value * 100) + '%';
        }
        function updateStringsDisplay(val) { document.getElementById('strings-val').innerText = val; state.strings = parseInt(val); updateTuning(); }
        function changeTranspose(delta) { state.transpose += delta; updateTuning(); }
        function updateTempo(val) { state.tempoFactor = val / 100; if(state.isPlaying && !state.isSongPlaying) { clearTimeout(sequencerId); startProceduralMusic(); } }
        function setVolume(val) { state.volume = parseFloat(val); if (masterGain) masterGain.gain.setValueAtTime(state.volume, audioCtx.currentTime); }
        function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => console.log(e)); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
        function getNoteName(index) { const normalized = ((index % 12) + 12) % 12; return NOTES[normalized]; }
        function calculateScale() {
            const modeIntervals = MODES[state.mode]; let notes = []; let freqs = []; let startMidi = 60 + state.transpose; if (state.strings > 10) startMidi -= 12;
            for (let i = 0; i < state.strings; i++) {
                const octaveOffset = Math.floor(i / 7); const scaleIndex = i % 7; const semitonesFromRoot = modeIntervals[scaleIndex]; const noteMidi = startMidi + (octaveOffset * 12) + semitonesFromRoot; const freq = 440 * Math.pow(2, (noteMidi - 69) / 12);
                notes.push({ name: getNoteName(noteMidi), octave: Math.floor(noteMidi / 12) - 1, freq: freq, midi: noteMidi }); freqs.push(freq);
            } return { notes, freqs };
        }
        function handleTouchStrum(e) { e.preventDefault(); const touch = e.touches[0]; const element = document.elementFromPoint(touch.clientX, touch.clientY); if (element && element.classList.contains('string-hitbox')) { const id = element.id; const index = parseInt(id.split('-')[1]); if (element.dataset.lastTouched !== "true") { playTone(state.freqs[index], index); document.querySelectorAll('.string-hitbox').forEach(el => el.dataset.lastTouched = "false"); element.dataset.lastTouched = "true"; setTimeout(() => element.dataset.lastTouched = "false", 200); } } }
        function toggleMusic() { clearTimeout(sequencerId); if (state.isSongPlaying) { state.isSongPlaying = false; document.getElementById('song-select').value = ""; } const btn = document.getElementById('play-btn'); if (state.isPlaying) { state.isPlaying = false; btn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg><span>Invocar a las Musas</span>`; btn.classList.remove('playing'); } else { if (state.isTunerActive) toggleTuner(); initAudio(); state.isPlaying = true; btn.innerHTML = `<svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg><span>Detener Música</span>`; btn.classList.add('playing'); startProceduralMusic(); } }
        function playSong(songKey) { clearTimeout(sequencerId); if (!songKey) return; if (state.isTunerActive) toggleTuner(); initAudio(); state.isSongPlaying = true; state.isPlaying = true; const btn = document.getElementById('play-btn'); btn.innerHTML = `<svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg><span>Interpretando Obra...</span>`; if (!btn.classList.contains('playing')) btn.classList.add('playing'); const song = SONGS[songKey]; document.getElementById('strings-range').value = song.strings; updateStringsDisplay(song.strings); document.getElementById('mode').value = song.mode; updateTuning(); let noteIndex = 0; const playNextNote = () => { if (!state.isSongPlaying) return; if (noteIndex >= song.notes.length) { noteIndex = 0; sequencerId = setTimeout(playNextNote, 2000); return; } const n = song.notes[noteIndex]; if (n.s < state.freqs.length) playTone(state.freqs[n.s], n.s); noteIndex++; sequencerId = setTimeout(playNextNote, n.d); }; playNextNote(); }
        function startProceduralMusic() { let currentIndex = Math.floor(state.strings / 2); const playNext = () => { if (!state.isPlaying || state.isSongPlaying) return; const numStrings = state.strings; const move = Math.random(); let nextIndex; if (move < 0.4) nextIndex = currentIndex + (Math.random() > 0.5 ? 1 : -1); else if (move < 0.7) nextIndex = currentIndex + (Math.random() > 0.5 ? 2 : -2); else if (move < 0.9) nextIndex = currentIndex; else nextIndex = Math.floor(Math.random() * numStrings); if (nextIndex < 0) nextIndex = 0; if (nextIndex >= numStrings) nextIndex = numStrings - 1; currentIndex = nextIndex; playTone(state.freqs[currentIndex], currentIndex); if (Math.random() > 0.75 && (currentIndex + 2) < numStrings) { setTimeout(() => { if(state.isPlaying && !state.isSongPlaying) playTone(state.freqs[currentIndex + 2], currentIndex + 2); }, 50); } const delayBase = 1200 - (state.tempoFactor * 1050); const randomVar = Math.random() * 200; sequencerId = setTimeout(playNext, delayBase + randomVar); }; playNext(); }
    </script>
</body>
</html>
